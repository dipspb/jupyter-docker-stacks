# Copyright (c) Jupyter Development Team.
# Distributed under the terms of the Modified BSD License.
FROM jupyter/scipy-notebook

LABEL maintainer="Dmitry Prokhorov <dipspb@gmail.com>"

RUN apt-get update && apt-get install -y --no-install-recommends \
        curl \
        libfreetype6-dev \
        libpng12-dev \
        libzmq3-dev \
        pkg-config \
        python3-dev \
        rsync \
        software-properties-common \
        unrar \
        tcl-dev \
        tk-dev \
        libleptonica-dev \
        libtesseract-dev \
        tesseract-ocr \
    && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

COPY requirements-gpu.txt  /tmp/requirements.txt
RUN conda install --yes --file /tmp/requirements.yml -v && \
    conda clean -tipsy && \
    fix-permissions $CONDA_DIR

# Copy English tessercat ocr data
COPY tessdata/* /usr/share/tesseract-ocr/tessdata/
ENV TESSDATA_PREFIX="/usr/share/tesseract-ocr/"

# Set up our notebook config.
COPY jupyter_notebook_config.py /tmp/
RUN cat jupyter_notebook_config.py >> /etc/jupyter/jupyter_notebook_config.py && \
    fix-permissions /etc/jupyter/

# Directory for keeping the MXNet model parameters
RUN mkdir -p /home/$NB_USER/.mxnet/models

# For CUDA profiling, TensorFlow requires CUPTI.
ENV LD_LIBRARY_PATH /usr/local/cuda/extras/CUPTI/lib64:$LD_LIBRARY_PATH

# TensorBoard
EXPOSE 6006
# Jupyter
EXPOSE 8888
# Flask Server
EXPOSE 4567

USER $NB_USER

